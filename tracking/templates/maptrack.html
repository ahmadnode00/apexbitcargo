<!-- History Section -->
<div class='card mb-4'>
  <div class='card-body'>
    <h4 class='text-bg-dark p-2 mb-3 text-center'>History</h4>
    <div class='row'>
      
      <!-- Map -->
      <div class='col-lg-5'>
        <div class='border mb-3'>
          <div id='map' style='height:400px;'></div>
        </div>
      </div>
      
      <!-- Shipment Table -->
      <div class='col-lg-7'>
        <div class='border p-2 fs-14px'>
          <div class="dt-container" data-domtablet="shipment">
            <div class="row row-cols-auto dt-widgets"></div>
            <div class="table-responsive">
              <table class="table" id="dt-shipment">
                <thead>
                  <tr>
                    <th>Country</th>
                    <th>State</th>
                    <th>Area</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>{{ shipment.receiver_country }}</td>
                    <td>{{ shipment.receiver_city }}</td>
                    <td>-</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="mt-3 dt-paginate"></div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Leaflet JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
  const receiverCity = "{{ shipment.receiver_city }}";
  const receiverCountry = "{{ shipment.receiver_country }}";

  // Use Nominatim to get coordinates from city + country
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${receiverCity}, ${receiverCountry}`)
    .then(response => response.json())
    .then(data => {
      if(data.length > 0){
        const lat = data[0].lat;
        const lon = data[0].lon;

        // Initialize map
        var map = L.map('map').setView([lat, lon], 10);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
        }).addTo(map);

        // Add marker for receiver city
        L.marker([lat, lon]).addTo(map)
          .bindPopup(`Receiver Location: ${receiverCity}`)
          .openPopup();
      } else {
        console.error("Could not find coordinates for:", receiverCity, receiverCountry);
        document.getElementById('map').innerHTML = "<p class='text-center text-muted mt-5'>Map location not found</p>";
      }
    });
</script>
